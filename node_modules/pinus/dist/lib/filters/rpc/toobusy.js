"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Filter for rpc log.
 * Reject rpc request when toobusy
 */
const pinus_logger_1 = require("pinus-logger");
let rpcLogger = pinus_logger_1.getLogger('rpc-log', __filename);
let toobusy = null;
let DEFAULT_MAXLAG = 70;
class RpcToobusyFilter {
    constructor(maxLag = DEFAULT_MAXLAG) {
        this.name = 'toobusy';
        try {
            toobusy = require('toobusy');
        }
        catch (e) {
        }
        if (!!toobusy) {
            toobusy.maxLag(maxLag);
        }
    }
    /**
     * Before filter for rpc
     */
    before(serverId, msg, opts, next) {
        opts = opts || {};
        if (!!toobusy && toobusy()) {
            rpcLogger.warn('Server too busy for rpc request, serverId:' + serverId + ' msg: ' + msg);
            let err = new Error('Backend server ' + serverId + ' is too busy now!');
            err.code = 500;
            next(err);
        }
        else {
            next();
        }
    }
}
exports.RpcToobusyFilter = RpcToobusyFilter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vYnVzeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9maWx0ZXJzL3JwYy90b29idXN5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7OztHQUdHO0FBQ0gsK0NBQXlDO0FBRXpDLElBQUksU0FBUyxHQUFHLHdCQUFTLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ2pELElBQUksT0FBTyxHQUFRLElBQUksQ0FBQztBQUV4QixJQUFJLGNBQWMsR0FBRyxFQUFFLENBQUM7QUFHeEI7SUFDSSxZQUFZLE1BQU0sR0FBRyxjQUFjO1FBVW5DLFNBQUksR0FBRyxTQUFTLENBQUM7UUFUYixJQUFJLENBQUM7WUFDRCxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2pDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2IsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ1osT0FBTyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQixDQUFDO0lBQ0wsQ0FBQztJQUlEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFFBQWdCLEVBQUUsR0FBUSxFQUFFLElBQVMsRUFBRSxJQUFxRTtRQUMvRyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNsQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxJQUFJLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztZQUN6QixTQUFTLENBQUMsSUFBSSxDQUFDLDRDQUE0QyxHQUFHLFFBQVEsR0FBRyxRQUFRLEdBQUcsR0FBRyxDQUFDLENBQUM7WUFDekYsSUFBSSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsaUJBQWlCLEdBQUcsUUFBUSxHQUFHLG1CQUFtQixDQUFDLENBQUM7WUFDdkUsR0FBVyxDQUFDLElBQUksR0FBRyxHQUFHLENBQUM7WUFDeEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2QsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxFQUFFLENBQUM7UUFDWCxDQUFDO0lBQ0wsQ0FBQztDQUNKO0FBM0JELDRDQTJCQyJ9